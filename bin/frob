#!/usr/bin/env ruby

# Load frob
require 'frob'

# Password mode
if ARGV.length == 2 && ARGV[0] == 'passwd'
  require 'digest/sha2'
  puts Digest::SHA512.hexdigest(ARGV[1])
  exit(0)

elsif ARGV.length > 1 || !File.exist?(ARGV[0])
  $stderr.puts "USAGE: frob [CONFIG_FILE]"
  $stderr.puts "     : frob passwd PASSWORD"
  exit(1)
end


# Load config from 
#  - /etc/frob.yml
#  - ~/.frob.yml
#  - ./frob.yml
require 'yaml'
config = {}
(Frob::CONFIG_LOCATIONS + [ARGV[0]]).each do |filename|
  config.merge!(YAML.load_file(filename)) if File.exist?(filename.to_s)
end

puts "CONFIG: #{config}"

begin
  # Load storage system
  store = Frob::Store.new(config[:store])

  # Load server
  server = Frob::Server.new(store, config[:users], config[:security], config[:interface], config[:port])

  server.start

ensure
  # Make sure we keep the store's indices up to date
  store.close if store
end
